<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>等级情况</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        body {}
    </style>
</head>

<body>
    <div class="aui-content aui-margin-b-15">
        <ul class="aui-list aui-form-list">
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-label">
                        会员类型
                    </div>
                    <div class="aui-list-item-input">
                        <select id="level">
                                <option>398会员</option>
                                <option>1314会员</option>
                                <option>8800会员</option>
                            </select>
                    </div>
                </div>
            </li>
            <li class="aui-list-item">
              <div class="aui-list-item-inner">
                  <div class="aui-list-item-label">
                      注意：
                  </div>
                  <div class="aui-list-item-title">
                    更改级别后余额中需要消费相应级别的费用，不得提现。
                  </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner aui-list-item-center aui-list-item-btn">
                    <div class="aui-btn aui-btn-info aui-margin-r-5" onclick="fnOk();">提交</div>
                    <div class="aui-btn aui-btn-danger aui-margin-l-5" onclick="fnCloseWin();">取消</div>
                </div>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript" src="../script/remotedb.js"></script>
<script type="text/javascript">
    apiready = function() {
        var isAuth = $api.getStorage('userInfo').IsAuth; //先验证后扫描

        if (!isAuth) {
            api.alert({
                title: '帮助',
                msg: '请先实名验证，验证后再充值入会金',
            }, function(ret, err) {
                if (ret) {
                    //alert( JSON.stringify( ret ) );
                    //打开验证窗口
                    api.openWin({
                        name: 'myauth',
                        url: './myauth.html',
                        pageParam: {
                            userid: $api.getStorage('userInfo').Id
                        }
                    });
                }
            });
        }
        fnInitYuE();
    };

    function fnInitYuE() {


        var filter = {
            where: {
                userid: $api.getStorage('userInfo').Id
            },
            //order: "createAt DESC",
            limit: 1,
            skip: 0
        };
        fnGet('Syswallet/GetWallet', filter, function(ret, err) {
            if (ret) {
                $api.setStorage('currentwallet', ret);
            } else {
                api.alert({
                    title: '消息',
                    msg: '查不到余额',
                });
            }
        });
    }

    function fnOk() {
        var level = $api.byId('level');
        var mywall = $api.getStorage('currentwallet').JieYu;
        var mustwall, levelid;
        if (level.value == '8800会员') {
            mustwall = 8800;
            levelid = '3';
        } else if (level.value == '1314会员') {
            mustwall = 1314;
            levelid = '2';
        } else {
            mustwall = 398;
            levelid = '1';
        }
        if (mywall >= mustwall) {
            api.alert({
                title: '消息',
                msg: '您选择的是 ' + level.value + ' ,是否提交办理？',
            }, function(ret, err) {
                if (ret) {
                    var filter = {
                            where: {
                                'userId': $api.getStorage('userInfo').Id
                            },
                            skip: 0,
                            limit: 1
                        }
                        //判断是新入会还是老会员
                    fnGet('SysUser/GetByIdFromJiaPu', filter, function(ret2, err) {
                      console.log(JSON.stringify(ret2));
                        if (ret2) {
                            var data = {
                                body: JSON.stringify({
                                    UserId: $api.getStorage('userInfo').Id,
                                    FirstJinE: mustwall,
                                    LevelId: levelid
                                })
                            };
                            fnPost('SysUser/EditJiaPu', data, 'application/json', false, false, function(ret3, err) {
                                if (ret3) {
                                    alert('变更成功！')
                                }
                            });
                        } else { //新会员
                            var data = {
                                body: JSON.stringify({
                                    uid: $api.getStorage('userInfo').Id,
                                    fje: mustwall
                                })
                            };
                            fnPost('SysUser/PutJiaPu', data, 'application/json', false, false, function(ret4, err) {
console.log(JSON.stringify(ret4));
                                    if (ret4) {
                                        alert('操作成功！')
                                    }
                                } //
                            );
                        }
                    });
                }
            });


        } else {
            api.alert({
                title: '消息',
                msg: '您选择的是 ' + level.value + ' ,因余额不足，需向余额充值到该会员金限额要求，是否充值？',
            }, function(ret, err) {
                if (ret) {
                    api.openWin({
                        name: 'mywallet',
                        url: './mywallet.html',
                        pageParam: {
                            levelvalue: mustwall,
                            levelid: levelid
                        }
                    });

                } else {
                    // alert( JSON.stringify( err ) );
                }
            });

        }
    }
    //关闭窗口
    function fnCloseWin() {
        api.closeWin({
            animation: {
                type: 'fade' // 指定窗口关闭的动画为淡入淡出
            }
        });
    }
</script>

</html>
